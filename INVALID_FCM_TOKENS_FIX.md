# ๐ง ุญู ูุดููุฉ FCM Tokens ุบูุฑ ุงูุตุงูุญุฉ

## ุงููุดููุฉ
ุงูุฎุทุฃ `messaging/registration-token-not-registered` ูุนูู ุฃู ุงูู FCM token ุบูุฑ ุตุงูุญ. ูุฐุง ูุญุฏุซ ุนูุฏูุง:
1. ุงููุณุชุฎุฏู ูุณุชุฎุฏู APK ูุฏูู (ูุจู ุฅุถุงูุฉ SHA fingerprints)
2. ุงูู token ููุชูู ุงูุตูุงุญูุฉ
3. ุงูุชุทุจูู ุฃุนูุฏ ุชุซุจูุชู ุจุฏูู ุชุณุฌูู ุฏุฎูู ุฌุฏูุฏ

## โ ุงูุญููู ุงููุทุจูุฉ

### 1. ุญุฐู ุชููุงุฆู ููู Tokens ุบูุฑ ุงูุตุงูุญุฉ
ุชู ุชุญุณูู `backend/utils/notificationService.js` ูุญุฐู ุงูู tokens ุบูุฑ ุงูุตุงูุญุฉ ุชููุงุฆูุงู ุนูุฏ ูุดู ุงูุฅุดุนุงุฑุงุช.

### 2. ุณูุฑูุจุช ุชูุธูู ุดุงูู
ุชู ุฅูุดุงุก `backend/scripts/cleanupInvalidFcmTokens.js` ูุชูุธูู ุฌููุน ุงูู tokens ุบูุฑ ุงูุตุงูุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

---

## ๐ ุงูุญู ุงูููุฑู

### ุงูุฎูุงุฑ 1: ุชูุธูู ูุฏูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ุงูุฃุณุฑุน)

ุฅุฐุง ููุช ุชุฑูุฏ ุญุฐู ุฌููุน ุงูู tokens ุงููุฏููุฉ ููุฑุงู:

```javascript
// ูู MongoDB shell ุฃู Compass
db.users.updateMany(
  { fcmToken: { $exists: true } },
  { $unset: { fcmToken: "" } }
);

db.drivers.updateMany(
  { fcmToken: { $exists: true } },
  { $unset: { fcmToken: "" } }
);
```

### ุงูุฎูุงุฑ 2: ุงุณุชุฎุฏุงู ุณูุฑูุจุช ุงูุชูุธูู

```bash
cd backend
node scripts/cleanupInvalidFcmTokens.js
```

**ููุงุญุธุฉ:** ุงูุณูุฑูุจุช ุณูุชุญูู ูู ูู token ููุญุฐู ุบูุฑ ุงูุตุงูุญ. ูุฏ ูุณุชุบุฑู ููุชุงู ุฅุฐุง ูุงู ูุฏูู ุนุฏุฏ ูุจูุฑ ูู ุงููุณุชุฎุฏููู.

### ุงูุฎูุงุฑ 3: ุงูุณูุงุญ ููููุฏ ุจุญุฐููุง ุชููุงุฆูุงู
ุงูููุฏ ุงูุขู ูุญุฐู ุงูู tokens ุบูุฑ ุงูุตุงูุญุฉ ุชููุงุฆูุงู ุนูุฏ ูุญุงููุฉ ุฅุฑุณุงู ุฅุดุนุงุฑ. ููู ูุฐุง ูุฏ ูุณุชุบุฑู ููุชุงู.

---

## ๐ฑ ุญู ุทููู ุงูุฃูุฏ: ุชุญุฏูุซ ุงูุชุทุจูู

### ูููุณุชุฎุฏููู:
1. **ุงุญุฐู ุงูุชุทุจูู ุงููุฏูู** ูู ุงูุฌูุงุฒ
2. **ุซุจุช APK ุฌุฏูุฏ** (ุจุนุฏ ุฅุถุงูุฉ SHA fingerprints)
3. **ุณุฌู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู** - ุณูุฑุณู token ุฌุฏูุฏ ููุณูุฑูุฑ

### ูููุทูุฑูู:
ุชุฃูุฏ ูู ุฃู:
- โ SHA fingerprints ูุถุงูุฉ ูู Firebase Console
- โ `google-services.json` ูุญุฏุซ
- โ APK ูุจูู ุจุนุฏ ุฅุถุงูุฉ SHA fingerprints

---

## ๐ ุงูุชุญูู ูู ุงููุดููุฉ

### ุชุญูู ูู ุงูู Tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

```javascript
// ูู MongoDB
// ุนุฏุฏ ุงููุณุชุฎุฏููู ูุน tokens
db.users.countDocuments({ fcmToken: { $exists: true, $ne: null, $ne: "" } });

// ุนุฏุฏ ุงูุณุงุฆููู ูุน tokens
db.drivers.countDocuments({ fcmToken: { $exists: true, $ne: null, $ne: "" } });

// ุนุฑุถ ุจุนุถ tokens (ููุชุญูู)
db.users.find({ fcmToken: { $exists: true } }, { name: 1, phone: 1, fcmToken: 1 }).limit(5);
```

### ุชุญูู ูู Logs:
ุงุจุญุซ ูู logs ุนู:
```
๐งน Removed invalid FCM token (...)
```
ูุฐุง ูุนูู ุฃู ุงูููุฏ ูุญุฐู ุงูู tokens ุบูุฑ ุงูุตุงูุญุฉ ุชููุงุฆูุงู.

---

## โ ุจุนุฏ ุงูุชูุธูู

ุจุนุฏ ุญุฐู ุงูู tokens ุบูุฑ ุงูุตุงูุญุฉ:
1. ุงููุณุชุฎุฏููู ุงูุฐูู ูุณุฌููู ุฏุฎูู ุณูุฑุณููู tokens ุฌุฏูุฏุฉ
2. ุงูุฅุดุนุงุฑุงุช ุณุชุนูู ููุท ูููุณุชุฎุฏููู ุงูุฐูู ูุฏููู tokens ุตุงูุญุฉ
3. ูุง ูุฒูุฏ ูู ุฃุฎุทุงุก `messaging/registration-token-not-registered`

---

## ๐ ููุฎุต

| ุงูุฅุฌุฑุงุก | ุงููุตู | ุงูููุช |
|---------|-------|-------|
| **ุญุฐู ูุฏูู** | ุญุฐู ุฌููุน tokens ููุฑุงู | โก ููุฑู |
| **ุณูุฑูุจุช ุชูุธูู** | ุงูุชุญูู ูุญุฐู ุบูุฑ ุงูุตุงูุญ ููุท | ๐ 1-5 ุฏูุงุฆู |
| **ุชููุงุฆู** | ุงูููุฏ ูุญุฐู ุนูุฏ ุงููุดู | ๐ ุชุฏุฑูุฌู |

**ุงูุชูุตูุฉ:** ุงุณุชุฎุฏู ุงูุญุฐู ุงููุฏูู ููุญู ุงูููุฑูุ ุซู ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏููู ูุณุชุฎุฏููู APK ุฌุฏูุฏ.

