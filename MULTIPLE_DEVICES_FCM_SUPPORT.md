# دعم عدة أجهزة لـ FCM Tokens

## المشكلة
كان النظام يحفظ **token واحد فقط** لكل مستخدم/سائق. عند تسجيل الدخول من جهاز جديد، يتم **استبدال** token الجهاز القديم، مما يعني أن الإشعارات تصل فقط للجهاز الأخير الذي سجل دخول.

## الحل
تم تحديث النظام لدعم **عدة tokens** (مصفوفة) لكل مستخدم/سائق، مما يسمح بإرسال الإشعارات لجميع الأجهزة المسجلة.

## التغييرات المطبقة

### 1. تحديث النماذج (Models)

#### `backend/models/User.js`
- تغيير `fcmToken` من `String` إلى `[String]` (مصفوفة)
- إضافة `default: []`

#### `backend/models/Driver.js`
- تغيير `fcmToken` من `String` إلى `[String]` (مصفوفة)
- إضافة `default: []`

### 2. تحديث Controllers

#### `backend/controllers/userController.js`
- **updateFcmTokenByPhone**: إضافة token جديد للمصفوفة بدلاً من الاستبدال
- **updateFcmToken**: إضافة token جديد للمصفوفة بدلاً من الاستبدال
- **checkFcmTokenStatus**: تحديث للتعامل مع المصفوفات وإظهار عدد الأجهزة

#### `backend/controllers/driverController.js`
- **updateFcmTokenByDriverId**: إضافة token جديد للمصفوفة بدلاً من الاستبدال
- **updateFcmToken**: إضافة token جديد للمصفوفة بدلاً من الاستبدال
- **checkFcmTokenStatus**: تحديث للتعامل مع المصفوفات وإظهار عدد الأجهزة

### 3. تحديث Notification Service

#### `backend/utils/notificationService.js`
- **removeInvalidToken**: تحديث لإزالة token غير صحيح من المصفوفة بدلاً من حذف الحقل بالكامل

### 4. تحديث Order Controller

#### `backend/controllers/orderController.js`
- إضافة دالة مساعدة `normalizeFcmTokens()` لتحويل string قديم إلى مصفوفة (للدعم العكسي)
- تحديث جميع المواضع التي تستخدم `fcmToken` لاستخدام `normalizeFcmTokens()` و `sendMulticastNotification()` بدلاً من `sendNotification()`
- إرسال الإشعارات لجميع tokens (جميع الأجهزة) بدلاً من جهاز واحد

## التوافق العكسي (Backwards Compatibility)

الكود يدعم **البيانات القديمة** تلقائياً:
- إذا كان `fcmToken` عبارة عن string (الصيغة القديمة)، يتم تحويله إلى مصفوفة تلقائياً
- إذا كان `fcmToken` عبارة عن مصفوفة (الصيغة الجديدة)، يتم التعامل معه مباشرة

## مثال على الاستخدام

### قبل التحديث:
```javascript
// token واحد فقط - يتم استبداله عند تسجيل الدخول من جهاز جديد
user.fcmToken = "token123"; // token الجهاز الأول يُستبدل
user.fcmToken = "token456"; // token الجهاز الثاني - الجهاز الأول لن يتلقى إشعارات
```

### بعد التحديث:
```javascript
// عدة tokens - جميع الأجهزة تتلقى إشعارات
user.fcmToken = ["token123", "token456"]; // كلا الجهازين يتلقيا إشعارات
user.fcmToken = ["token123", "token456", "token789"]; // 3 أجهزة
```

## الفوائد

1. ✅ **دعم عدة أجهزة**: المستخدم/السائق يمكنه تسجيل الدخول من عدة أجهزة وتلقي الإشعارات على جميعها
2. ✅ **لا فقدان للبيانات**: لا يتم استبدال tokens الأجهزة القديمة
3. ✅ **إرسال شامل**: الإشعارات تُرسل لجميع الأجهزة المسجلة
4. ✅ **التوافق العكسي**: البيانات القديمة تعمل بدون مشاكل

## ملاحظات مهمة

1. **البيانات الموجودة**: البيانات القديمة (string) ستعمل تلقائياً وسيتم تحويلها لمصفوفات عند التحديث
2. **الأداء**: إرسال الإشعارات لعدة أجهزة قد يستغرق وقتاً أطول قليلاً، لكن هذا مقبول لضمان وصول الإشعارات
3. **التنظيف**: tokens غير صحيحة يتم إزالتها تلقائياً من المصفوفة عند فشل الإرسال

## الاختبار

للتحقق من أن النظام يعمل بشكل صحيح:

1. سجل الدخول من جهازين مختلفين بنفس الحساب
2. تحقق من أن كلا الجهازين لديهما tokens مختلفة في قاعدة البيانات
3. أنشئ طلب/أرسل إشعار - يجب أن يصل لكلا الجهازين

