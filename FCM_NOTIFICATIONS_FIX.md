# ๐ ุฅุตูุงุญ ูุดููุฉ ุนุฏู ุธููุฑ ุงูุฅุดุนุงุฑุงุช

## ุงููุดููุฉ
ุงูุฅุดุนุงุฑุงุช ูุง ุชุธูุฑ ูุฃู:
1. **FCM tokens ุบูุฑ ูุญููุธุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช** - ุงููุณุชุฎุฏููู ูุงูุณุงุฆููู ูุง ูููููู FCM tokens
2. **ุงูุจุญุซ ุนู ุงููุณุชุฎุฏููู ุจุฑูู ุงููุงุชู ููุดู** - ุงูููุฏ ูุจุญุซ ุจุงูุตูุบุฉ ุงูุฌุฏูุฏุฉ ููุท (+964) ุจูููุง ูุฏ ุชููู ุงูุจูุงูุงุช ุจุงูุตูุบุฉ ุงููุฏููุฉ (0...)

## โ ุงูุญููู ุงููุทุจูุฉ

### 1. ุฅุตูุงุญ ุงูุจุญุซ ุนู ุงููุณุชุฎุฏููู ุจุฑูู ุงููุงุชู

**ุงููุดููุฉ:** `updateFcmTokenByPhone` ูุงูุช ุชุจุญุซ ููุท ุจุงูุตูุบุฉ ุงูููุญุฏุฉ ูููุงุชูุ ููุง ูููุน ุชุญุฏูุซ FCM tokens ูููุณุชุฎุฏููู ุงูุฐูู ูุฏููู ุฃุฑูุงู ุจุงูุตูุบุฉ ุงููุฏููุฉ.

**ุงูุญู:** ุชู ุชุญุฏูุซ `updateFcmTokenByPhone` ูู `backend/controllers/userController.js` ูุงุณุชุฎุฏุงู `findUserByPhone` ุงูุชู ุชุฏุนู ููุง ุงูุตูุบุชูู:

```javascript
// ูุจู ุงูุฅุตูุงุญ
const user = await User.findOne({ phone: normalizedPhone });

// ุจุนุฏ ุงูุฅุตูุงุญ
const user = await exports.findUserByPhone(phone); // ูุฏุนู ุงูุตูุบุชูู ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ
```

### 2. ุฅุตูุงุญ ุงูุจุญุซ ูู orderController

**ุงููุดููุฉ:** ูู `orderController.js`ุ ูุงู ุงูุจุญุซ ุนู ุงููุณุชุฎุฏููู ูุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช ูุณุชุฎุฏู `User.findOne` ูุจุงุดุฑุฉ.

**ุงูุญู:** ุชู ุชุญุฏูุซ ุฌููุน ุงูุฃูุงูู ูุงุณุชุฎุฏุงู `findUserByPhone`:

```javascript
// ูู sendStatusUpdateNotifications
const customer = await findUserByPhone(newOrder.customerPhone);
```

### 3. ุชุญุณูู Logging

ุชู ุฅุถุงูุฉ logging ุฃูุถู ูุชุชุจุน ุชุญุฏูุซ FCM tokens:

```javascript
// ูู userController.js ู driverController.js
logger.success(`โ Updated FCM token for user ${user.name} (${user.phone})`);
logger.debug(`   Old token: ${oldToken ? oldToken.substring(0, 20) + '...' : 'none'}`);
logger.debug(`   New token: ${fcmToken.substring(0, 20)}...`);
```

## ๐ ุฎุทูุงุช ุงูุญู

### ูููุณุชุฎุฏููู:
1. **ุณุฌู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู** - ุณูุชู ุฅุฑุณุงู FCM token ุชููุงุฆูุงู ููุณูุฑูุฑ
2. **ุชุฃูุฏ ูู ุฃู ุงูุชุทุจูู ูุญุฏุซ** - APK ุฌุฏูุฏ ูุน SHA fingerprints

### ูููุทูุฑูู:
1. **ุชุญูู ูู Logs** - ุงุจุญุซ ุนู:
   ```
   โ Updated FCM token for user ...
   โ Updated FCM token for driver ...
   ```
2. **ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช** - ุชุฃูุฏ ูู ูุฌูุฏ FCM tokens:
   ```javascript
   // ูู MongoDB
   db.users.find({ phone: "+9647654321000" }, { fcmToken: 1 });
   db.drivers.find({ driverId: "A1" }, { fcmToken: 1 });
   ```

## ๐ ุงูุชุญูู ูู ุงููุดููุฉ

### ุชุญูู ูู FCM Tokens ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช:

```javascript
// ุนุฏุฏ ุงููุณุชุฎุฏููู ูุน tokens
db.users.countDocuments({ 
  fcmToken: { $exists: true, $ne: null, $ne: "" } 
});

// ุนุฏุฏ ุงูุณุงุฆููู ูุน tokens
db.drivers.countDocuments({ 
  fcmToken: { $exists: true, $ne: null, $ne: "" } 
});

// ุงูุจุญุซ ุนู ูุณุชุฎุฏู ูุนูู
db.users.find({ 
  $or: [
    { phone: "+9647654321000" },
    { phone: "07654321000" },
    { phone: "9647654321000" }
  ]
}, { name: 1, phone: 1, fcmToken: 1 });
```

### ุชุญูู ูู Logs:

ุงุจุญุซ ูู logs ุนู:
- `โ Updated FCM token` - ูุนูู ุฃู Token ุชู ุชุญุฏูุซู ุจูุฌุงุญ
- `โ๏ธ Customer found but no FCM token` - ูุนูู ุฃู ุงููุณุชุฎุฏู ููุฌูุฏ ููู ูุง ูููู token
- `โ๏ธ Found drivers but none have FCM tokens` - ูุนูู ุฃู ุงูุณุงุฆููู ููุฌูุฏูู ููู ูุง ูููููู tokens

## ๐ ุงูุญู ุงูููุฑู

### ุฅุฐุง ูุงูุช FCM tokens ููููุฏุฉ:

1. **ุงุทูุจ ูู ุงููุณุชุฎุฏููู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู** - ุณูุชู ุฅุฑุณุงู tokens ุชููุงุฆูุงู
2. **ุงุทูุจ ูู ุงูุณุงุฆููู ุชุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู** - ุณูุชู ุฅุฑุณุงู tokens ุชููุงุฆูุงู

### ููุชุญูู ูู ุฃู ุงูุฅุตูุงุญ ูุนูู:

1. ุณุฌู ุฏุฎูู ููุณุชุฎุฏู ุฃู ุณุงุฆู
2. ุชุญูู ูู logs - ูุฌุจ ุฃู ุชุฑู:
   ```
   โ Updated FCM token for user ...
   ```
3. ุชุญูู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ูุฌุจ ุฃู ุชุฑู FCM token ูุญููุธ

## ๐ ููุฎุต ุงูุชุบููุฑุงุช

| ุงูููู | ุงูุชุบููุฑ | ุงููุตู |
|------|---------|-------|
| `backend/controllers/userController.js` | โ ุฅุตูุงุญ | ุงุณุชุฎุฏุงู `findUserByPhone` ุจุฏูุงู ูู `User.findOne` |
| `backend/controllers/orderController.js` | โ ุฅุตูุงุญ | ุงุณุชุฎุฏุงู `findUserByPhone` ูู `sendStatusUpdateNotifications` |
| `backend/controllers/driverController.js` | โ ุชุญุณูู | ุฅุถุงูุฉ logging ุฃูุถู ูุชุญุฏูุซ FCM tokens |

## โ ุจุนุฏ ุงูุฅุตูุงุญ

ุจุนุฏ ุชุทุจูู ูุฐู ุงูุฅุตูุงุญุงุช:
1. โ ุงูุจุญุซ ุนู ุงููุณุชุฎุฏููู ุณูุนูู ูุน ููุง ุงูุตูุบุชูู (ุงููุฏููุฉ ูุงูุฌุฏูุฏุฉ)
2. โ FCM tokens ุณูุชู ุชุญุฏูุซูุง ุจุดูู ุตุญูุญ ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู
3. โ ุงูุฅุดุนุงุฑุงุช ุณุชุนูู ูููุณุชุฎุฏููู ูุงูุณุงุฆููู ุงูุฐูู ูุฏููู tokens ุตุงูุญุฉ

---

**ููุงุญุธุฉ:** ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉุ ุชุฃูุฏ ูู:
- โ Firebase credentials ุตุญูุญุฉ ูู environment variables
- โ APK ูุจูู ุจุนุฏ ุฅุถุงูุฉ SHA fingerprints
- โ ุงููุณุชุฎุฏููู ูุงูุณุงุฆููู ุณุฌููุง ุฏุฎูู ุจุนุฏ ุงูุฅุตูุงุญ

